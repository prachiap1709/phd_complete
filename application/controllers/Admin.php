<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Admin extends CI_Controller {	function __construct() {        parent::__construct();		error_reporting(0);		$this->load->model('admin_model');		$this->load->library('Mandrill_Api');    }		public function index()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$data['module'] = 'admin';			$data['result'] = $this->admin_model->viewrecord('','ADMIN');						$data['mtitle'] =  'Manage Users - '.WEBNAME;			$data['main_content'] = 'admin/index';			$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}	public function consultant()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$data['module'] = 'admin';			$data['result'] = $this->admin_model->viewrecord('','consultant');			$data['user_type'] =  'consultant';			$data['mtitle'] =  'Manage Consultants - '.WEBNAME;						$data['main_content'] = 'admin/index';			$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function executive()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$data['module'] = 'admin';			$data['result'] = $this->admin_model->viewrecord('','executive');			$data['user_type'] =  'executive';			$data['mtitle'] =  'Manage Executives - '.WEBNAME;			$data['main_content'] = 'admin/index';			$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}	public function add()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$data['module'] = 'admin';						$data['mtitle'] =  'Add Users - '.WEBNAME;						$user_type = $this->uri->segment(3);			$data['user_type'] =  $user_type;						$data['main_content'] = 'admin/add';			$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function insertadmin()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$admin_type 	= $this->input->post('admin_type');			if($admin_type == 'CONSULTANT');			{				$code_sprtr	= 'CNSLT#'.rand(11111,99999);			}						if($admin_type == 'EXECUTIVE');			{				$code_sprtr	= 'EXEC#'.rand(11111,99999);			}						//$usercode		= getadmincode($code_sprtr);			$usercode		= $code_sprtr;			$password 		= $this->input->post('password');			$name 			= $this->input->post('name');			$email 			= $this->input->post('email');			$phone 			= $this->input->post('phone');			$tags 			= $this->input->post('tags');			$description 	= $this->input->post('description');			$data = array(				'fld_admin_type'			=>	$admin_type,				'fld_client_code'			=>	$usercode,				'fld_password'				=>	md5($password),				'fld_decrypt_password'		=>	$password,				'fld_name'					=>	$name,				'fld_email'					=>	trim($email),				'fld_phone'					=>	$phone,				'fld_tags'					=>	$tags,				'fld_description'			=>	$description,				'fld_addedon'				=>	date('Y-m-d')			);						$insertid = $this->admin_model->insertadmin($data,$email);			if($insertid>0)			{				if($admin_type == 'CONSULTANT')				{					$data_settting = array(						'fld_consultantid' 			=> $insertid,						'fld_selected_week_days' => '2,3,4,5,6',						'fld_mon_time_data' 		=> '09:00||18:00',						'fld_tue_time_data' 		=> '09:00||18:00',						'fld_wed_time_data' 		=> '09:00||18:00',						'fld_thu_time_data' 		=> '09:00||18:00',						'fld_fri_time_data' 			=> '09:00||18:00',						'fld_addedon' 				=> date('Y-m-d H:i:s'),						'fld_updatedon' 			=> date('Y-m-d H:i:s')					);					$this->db->insert('tbl_consultant_setting', $data_settting);										$data_settting_question = array(						'fld_consultantid' 			=> $insertid,						'fld_addedon' 				=> date('Y-m-d H:i:s'),						'fld_updatedon' 			=> date('Y-m-d H:i:s')					);					$this->db->insert('tbl_consultant_question_data', $data_settting_question);				}				$this->load->library('image_lib');								if (isset ( $_FILES['profileimage'] ) && $_FILES['profileimage'] ['error'] == 0)				{					$ext = end(explode('.',$_FILES ['profileimage']['name']));					$new_name = "LDPNL_PROF".rand('1000','9999').time() . '.' . $ext; 					UPLOADDIRPATH.'/assets/profileimg/'.$new_name;					$config['upload_path'] = UPLOADDIRPATH.'/assets/profileimg/';					$config['allowed_types'] = 'gif|jpg|png';					//$config['max_size']	= '100';					$config['file_name'] = $new_name;					$this->load->library('upload', $config);					$this->upload->initialize($config);					if ( ! $this->upload->do_upload('profileimage'))					{						$error = array('error' => $this->upload->display_errors());						echo preTagdata($error);						exit;					}					else					{						list($w, $h) = getimagesize(UPLOADDIRPATH.'/assets/profileimg/'.$new_name);						// START SMALL IMG						$n_w = 150; // destination image's width						$n_h = 150; // destination image's height						$source_ratio = $w / $h;						$new_ratio = $n_w / $n_h;						$config = array();						// create resized image						$config['image_library'] = 'GD2';						$config['source_image']	= UPLOADDIRPATH.'/assets/profileimg/'.$new_name;						$config['new_image'] = UPLOADDIRPATH.'/assets/profileimg/'.$new_name;						$config['create_thumb'] = false;						$config['maintain_ratio'] = true;												if($new_ratio > $source_ratio || (($new_ratio == 1) && ($source_ratio < 1))){							$config['width'] = $n_w;							$config['height'] = round($w/$new_ratio);							$config['y_axis'] = round(($h - $config['height'])/2);							$config['x_axis'] = 0;						} else {							$config['width'] = round($h * $new_ratio);							$config['height'] = $n_h;							$size_config['x_axis'] = round(($w - $config['width'])/2);							$size_config['y_axis'] = 0;						}						$this->image_lib->clear();						$this->image_lib->initialize($config);						$this->image_lib->resize();						// END SMALL IMG						$data = array(							'fld_profile_image' =>	$new_name,												);						$this->db->where('id',$insertid);							$this->db->update('tbl_admin',$data);					}				}				$mandrill = new Mandrill(MANDRILL_KEY);				$Subject = "Account created on ".WEBNAME;				$body = "Hi ".$name.", <br/><br/>  Greetings from ".WEBNAME."!<br/><br/>				Your account is successfully created on PhD Guidance. You can login using the credentials as below -<br/><br/>";				$body.='<strong>URL: </strong>'.base_url().'login<br/>';				$body.='<strong>Email: </strong>'.$this->input->post('email').'<br/>';				$body.='<strong>Password: </strong>'.$this->input->post('password').'<br/><br/>';									$body .="<br>Thanks & Regards <br/> ".WEBNAME."<br /> ";				$message = array(					'html' => $body,					'subject' => $Subject,					'from_email' => FROM_EMAIL,					'from_name' => FROM_NAME,					'to' => array(						array(							'email' => $email,							'name' => $name,							'type' => 'to'						)					)				);				$async = false;				$ip_pool = '';				if($_SERVER['HTTP_HOST']!="localhost")				{					$result = $mandrill->messages->send($message, $async, $ip_pool);				}								$this->session->set_userdata('alert_type', 'success');				$this->session->set_userdata('msg', 'Sub Admin Info. Added Successfully');								$redirectto  = 'executive';				if($admin_type == 'CONSULTANT')				{					$redirectto  = 'consultant';				}				redirect(base_url().'admin/'.$redirectto);			}			else			{								$this->db->select('fld_admin_type');				$this->db->from('tbl_admin');				$this->db->where('fld_email',$email);				$query2 = $this->db->get();				$result2 = $query2->row();				$admin_type = $result2->fld_admin_type;				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Sub Admin Info. Already Exist! As '.$admin_type);				redirect(base_url().'admin');			}		}		else		{			redirect(base_url());		}	}		public function edit()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$adminid = $this->uri->segment(3);						$data['module'] = 'admin';			$data['adminid'] = $adminid;			$data['result'] = $this->admin_model->viewrecord($adminid);			$data['mtitle'] =  'Edit Users - '.WEBNAME;			$data['main_content'] = 'admin/edit';			$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function updateadmin()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$adminid 		= $this->input->post('adminid');			$password 		= $this->input->post('password');			$name 			= $this->input->post('name');			$email 			= $this->input->post('email');						$phone 			= $this->input->post('phone');			$tags 			= $this->input->post('tags');			$description 	= $this->input->post('description');			$data = array(				'fld_name'			=>	$name,				'fld_phone'			=>	$phone,				'fld_email'			=>	trim($email),				'fld_tags'			=>	$tags,				'fld_description'	=>	$description,			);						if($password!="")			{				$data['fld_password']			=	md5($password);				$data['fld_decrypt_password']	=	$password;			}			$result = $this->admin_model->updateadmin($data,$adminid);						if($result>0)			{				$this->load->library('image_lib');								if (isset ( $_FILES['profileimage'] ) && $_FILES['profileimage'] ['error'] == 0)				{					$oldprofileimage = $this->input->post('oldprofileimage');					if($oldprofileimage!="")					{						unlink(UPLOADDIRPATH.'/assets/profileimg/'.$oldprofileimage);					}										$ext = end(explode('.',$_FILES ['profileimage']['name']));										$new_name = "LDPNL_PROF".rand('1000','9999').time() . '.' . $ext; 					UPLOADDIRPATH.'/assets/profileimg/'.$new_name;																$config['upload_path'] = UPLOADDIRPATH.'/assets/profileimg/';					$config['allowed_types'] = 'gif|jpg|png';					//$config['max_size']	= '100';					$config['file_name'] = $new_name;										$this->load->library('upload', $config);					$this->upload->initialize($config);					if ( ! $this->upload->do_upload('profileimage'))					{						$error = array('error' => $this->upload->display_errors());						echo preTagdata($error);						exit;					}					else					{						list($w, $h) = getimagesize(UPLOADDIRPATH.'/assets/profileimg/'.$new_name);												// START SMALL IMG						$n_w = 150; // destination image's width						$n_h = 150; // destination image's height												$source_ratio = $w / $h;						$new_ratio = $n_w / $n_h;																		$config = array();												// create resized image						$config['image_library'] = 'GD2';						$config['source_image']	= UPLOADDIRPATH.'/assets/profileimg/'.$new_name;						$config['new_image'] = UPLOADDIRPATH.'/assets/profileimg/'.$new_name;						$config['create_thumb'] = false;						$config['maintain_ratio'] = true;												if($new_ratio > $source_ratio || (($new_ratio == 1) && ($source_ratio < 1))){							$config['width'] = $n_w;							$config['height'] = round($w/$new_ratio);							$config['y_axis'] = round(($h - $config['height'])/2);							$config['x_axis'] = 0;													} else {														$config['width'] = round($h * $new_ratio);							$config['height'] = $n_h;							$size_config['x_axis'] = round(($w - $config['width'])/2);							$size_config['y_axis'] = 0;						}												$this->image_lib->clear();						$this->image_lib->initialize($config);						$this->image_lib->resize();												// END SMALL IMG																		$data = array(							'fld_profile_image' =>	$new_name,												);						$this->db->where('id',$adminid);							$this->db->update('tbl_admin',$data);					}									}				$this->session->set_userdata('alert_type', 'success');				$this->session->set_userdata('msg', 'Sub Admin Info. Updated Successfully');				redirect(base_url().'admin');			}			else			{				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Sub Admin Info. Not Updated!');				redirect(base_url().'admin');			}		}		else		{			redirect(base_url());		}	}	public function deleteadmin()	{		if($this->session->userdata('adm_logged_in') == true && $this->session->userdata('adm_admin_type') == 'SUPERADMIN')		{			$adminid = $this->uri->segment(3);						$result = $this->admin_model->deleteadmin($adminid);			if($result>0)			{				$this->session->set_userdata('alert_type', 'success');				$this->session->set_userdata('msg', 'Sub Admin Info. Deleted Successfully');				redirect(base_url().'admin');			}			else			{				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Sub Admin Info. Not Deleted !');				redirect(base_url().'admin');			}		}		else		{			redirect(base_url());		}	}			public function viewbooking()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN' || $this->session->userdata('adm_admin_type') == 'CONSULTANT'))		{			$adminid = $this->uri->segment(3);									$data['module'] = 'admin';			$data['adminid'] = $adminid;			$data['result'] = $this->admin_model->viewbooking('',$adminid);			$data['mtitle'] =  'Manage Booking- '.WEBNAME;			$data['main_content'] = 'admin/viewbooking';						$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function booking_detail()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN' || $this->session->userdata('adm_admin_type') == 'CONSULTANT' || $this->session->userdata('adm_admin_type') == 'EXECUTIVE'))		{			$bookingid = $this->uri->segment(3);			$data['module'] = 'admin';			$data['bookingid'] = $bookingid;						$data['result'] = $this->admin_model->viewbooking($bookingid);			$data['mtitle'] =  'Manage Booking- '.WEBNAME;			$data['main_content'] = 'admin/booking_detail';						$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function package_detail()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN'))		{			$data['module'] = 'admin';						$data['result'] = $this->admin_model->viewpackage();			$data['mtitle'] =  'Manage Package - '.WEBNAME;			$data['main_content'] = 'admin/package_detail';						$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function updatepackage()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN'))		{			//preTagdata($_REQUEST);			$main_amt 	= $this->input->post('main_amt');			$discount_amt 	= $this->input->post('discount_amt');			$timeline 	= $this->input->post('timeline');			$zoom_call 	= $this->input->post('zoom_call');			$call_time 	= $this->input->post('call_time');			$row_id 	= $this->input->post('row_id');						//echo $row_id;						if(count($row_id)>0)			{				for($i=0; $i<count($row_id); $i++)				{					$data = array(						'fld_main_amt' 		=> $main_amt[$i],						'fld_discount_amt' 	=> $discount_amt[$i],						'fld_timeline' 		=> $timeline[$i],						'fld_zoom_call' 	=> $zoom_call[$i],						'fld_call_time' 	=> $call_time[$i],					);										$this->db->where('id',$row_id[$i]);						$this->db->update('tbl_package',$data);				}								$this->session->set_userdata('alert_type', 'success');				$this->session->set_userdata('msg', 'Package Info. Updated Successfully');				redirect(base_url().'admin/package_detail');			}			else			{				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Package Info. Not Updated!');				//redirect(base_url().'admin/package_detail');			}		}		else		{			redirect(base_url());		}	}		public function reminder()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN' || $this->session->userdata('adm_admin_type') == 'EXECUTIVE'))		{			$bookingid = $this->uri->segment(3);			$data['module'] = 'admin';			$data['bookingid'] = $bookingid;						$data['result'] = $this->admin_model->viewbooking($bookingid);			$data['mtitle'] =  'Manage Reminders- '.WEBNAME;			$data['main_content'] = 'admin/reminder';						$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}		public function chat()	{		if($this->session->userdata('adm_logged_in') == true && ($this->session->userdata('adm_admin_type') == 'SUPERADMIN' || $this->session->userdata('adm_admin_type') == 'CONSULTANT'))		{			if(is_numeric($this->uri->segment(3)) && $this->uri->segment(3)!="")			{				$consultantid = $this->uri->segment(3);				$data['consultantid'] =  $consultantid;			}			$data['module'] = 'admin';			$data['submodule'] = 'chat';						$data['mtitle'] =  'Chat- '.WEBNAME;			$data['main_content'] = 'admin/chat';						$this->load->view('common/template.php',$data);		}		else		{			redirect(base_url());		}	}}