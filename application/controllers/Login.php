<?phpdefined('BASEPATH') OR exit('No direct script access allowed');class Login extends CI_Controller {	function __construct() {        parent::__construct();        $this->load->model('login_model');		$this->load->library('Mandrill_Api');		error_reporting(0);    }		public function index()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{			$action = $this->input->get_post('regifrm');			$id = $this->input->get_post('tmp');						if($action == 'template' && $id>0)			{				redirect(base_url().'registration/'.$id);			}						$data['main_content'] = 'login';			$this->load->view('login',$data);		}	}		public function authenticate()	{			$username = $this->input->post('username');		$userpass = $this->input->post('userpass');				$authenticateSts = $this->login_model->authenticate($username, $userpass);		if($authenticateSts>0)		{			redirect(base_url().'dashboard/');		}		else		{			$data['msg'] = 'Invalid login credentials or your account is deactivated by administrator !';			$data['main_content'] = 'login';			$this->load->view('login',$data);		}			}		public function verify()	{		$data['module'] = 'verify';		$verifycode 	= $this->uri->segment(3);		$userid 		= $this->uri->segment(4);				if($verifycode!="" && $userid!="")		{			$result = $this->login_model->verify($verifycode,$userid);						if($result == 'success')			{				$this->db->select('*');				$this->db->from('tbl_admin');				$this->db->where('id',$userid);				$this->db->where('status','Active');				$query = $this->db->get();				//echo $this->db->last_query();				//echo $query->num_rows();				//exit;				if($query->num_rows()>0)				{									$result = $query->row();											$name = $result->fld_name;					$email = $result->fld_email;					//exit;										$acnt_mngr_id	= $result->fld_acnt_mngr_id;					$currency 		= $result->fld_currency;					$admin_type 	= $result->fld_admin_type;					$admin_name 	= $result->fld_name;					$admin_email 	= $result->fld_email;					$admin_phone 	= $result->fld_phone;					$admin_id 		= $result->id;					$this->session->set_userdata('adm_logged_in',true);					$this->session->set_userdata('adm_admin_name',$admin_name);										$this->session->set_userdata('adm_admin_email',$admin_email);					$this->session->set_userdata('adm_admin_phone',$admin_phone);					$this->session->set_userdata('adm_admin_id',$admin_id);					$this->session->set_userdata('adm_admin_type',$admin_type);										$this->session->set_userdata('adm_admin_acnt_mngr_id',$acnt_mngr_id);										if($this->session->userdata('adm_admin_type') == 'CLIENT')					{						if($this->session->userdata('adm_admin_phone')!="")						{							$template = "Dear ".$this->session->userdata('adm_admin_name')." Your account is successfully verified and now you are a part of PhD Guidance family. Login to your dashboard and avail services and offers";														//sendwhatsappmsg($this->session->userdata('adm_admin_phone'),$template);						}												$this->session->set_userdata('adm_admin_currency',$currency);						if(!empty($_SERVER['HTTP_CLIENT_IP'])){							//ip from share internet							$ip = $_SERVER['HTTP_CLIENT_IP'];						}elseif(!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){							//ip pass from proxy							$ip = $_SERVER['HTTP_X_FORWARDED_FOR'];						}else{							$ip = $_SERVER['REMOTE_ADDR'];						}												$data = array(							'fld_clientid'		=>	$admin_id,							'fld_ipaddress'		=>	$ip,							'fld_login_time'	=>	date('Y-m-d H:i:s'),						);						$this->db->insert('tbl_login_history',$data);												$insertid = $this->db->insert_id();						$this->session->set_userdata('adm_admin_loginid',$insertid);					}										$mandrill = new Mandrill(MANDRILL_KEY);					$Subject = "PhD Wallet Account Verified & Activated";					$body = emailerDesign(1);					$body .= 'Hi '.$name.'<br/><br/>						 					Your account is successfully verified now. You can now explore the services and avail any of them using the funds that are added in your PhD Wallet along with many more features to explore.<br/><br/>												We are happy that you are part of our family now<br/><br/><br/>					Thanks &amp; Regards<br/>					Team '.WEBNAME;					$body .= emailerDesign(2);					$message = array(					'html' => $body,					'subject' => $Subject,					'from_email' => FROM_EMAIL,					'from_name' => FROM_NAME,					'to' => array(					array(					'email' => $email,					'name' => $name,					'type' => 'to'					)					)					);					$async = false;					$ip_pool = '';					if($_SERVER['HTTP_HOST']!="localhost")					{						$result = $mandrill->messages->send($message, $async, $ip_pool);					}									}								//$this->session->set_userdata('alert_type', 'success');				//$this->session->set_userdata('msg', 'We have successfully verified your email id and to be a part of our family and explore services please verify your mobile no.');				redirect(base_url().'login/verify_step2/'.$userid);			}			else			{				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Invalid Verify Code Or Your Account Is Already Active!');				redirect(base_url().'login');			}		}		else		{			redirect(base_url());		}	}	public function verify_step2()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{						$data['module'] = 'verify';						$data['userid'] = $userid = $this->uri->segment(3);;			if($userid!="")			{				$data['result'] 		= getAdmin($userid,'CLIENT');				$data['main_content'] 	= 'verify_mobile';				$this->load->view('verify_mobile',$data);			}			else			{				redirect(base_url());			}		}	}			public function send_otp()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{				$phone 	= $this->input->post('phone');			$userid = $this->input->post('userid');						if($userid > 0 && $phone > 0)			{				$this->db->select('*');				$this->db->from('tbl_admin');				$this->db->where('fld_verify','');				$this->db->where('fld_verify_mob!=','');				$this->db->where('id',$userid);				$this->db->where('status','Inactive');				$query = $this->db->get();				//echo $this->db->last_query();				//echo $query->num_rows();				//exit;				if($query->num_rows()>0)				{					$verify = rand(111111,999999);					$data = array('fld_phone' => $phone, 'fld_verify_mob'=>$verify);					$this->db->where('status','Inactive');					$query = $this->db->update('tbl_admin',$data);															$template = "Your OTP is: ".$verify.' Use the above one time password to verify your identity on PhD Guidance';					$isd = 91;										$data_api = array(						'user' => "EmarketzIndia",						'password'=> "Puneet@123",						'msisdn' => $isd.$phone,						'sid' => "PhDGDN",						'msg' => $template,						'fl' =>"0",						'gwid'=> 2,					);					//'user' => "EmarketzIndia",					//'password'=> 'Puneet@123',					//print_r($data_api);					list($header, $content) = PostRequest("http://cloud.smsindiahub.in/vendorsms/pushsms.aspx", "",$data_api);														$data_api = json_decode($content);					print_r($data_api);										echo  'success';					exit;				}				else				{					return 'danger';					exit;				}			}			else			{				redirect(base_url());			}		}	}		public function verify_mob()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{				$otpcode 	= $this->input->post('otpcode');			$userid 	= $this->input->post('userid');											if($userid > 0 && $otpcode > 0)			{							$this->db->select('*');				$this->db->from('tbl_admin');				$this->db->where('fld_verify_mob',$otpcode);				$this->db->where('fld_admin_type','CLIENT');				$this->db->where('id',$userid);				$this->db->where('status','Inactive');				$query = $this->db->get();				//echo $this->db->last_query();				//echo $query->num_rows();				//exit;				if($query->num_rows()>0)				{					$data2 = array('fld_verify_mob'=>'', 'status'=>'Active');										$this->db->where('fld_verify_mob',$otpcode);					$this->db->where('status','Inactive');					$this->db->where('fld_admin_type','CLIENT');					$this->db->where('id',$userid);					$this->db->update('tbl_admin',$data2);										$result = $query->row();										$name = $result->fld_name;					$email = $result->fld_email;										$acnt_mngr_id	= $result->fld_acnt_mngr_id;					$currency 		= $result->fld_currency;					$admin_type 	= $result->fld_admin_type;					$admin_name 	= $result->fld_name;					$admin_email 	= $result->fld_email;					$admin_id 		= $result->id;					$this->session->set_userdata('adm_logged_in',true);					$this->session->set_userdata('adm_admin_name',$admin_name);										$this->session->set_userdata('adm_admin_email',$admin_email);					$this->session->set_userdata('adm_admin_id',$admin_id);					$this->session->set_userdata('adm_admin_type',$admin_type);										$this->session->set_userdata('adm_admin_acnt_mngr_id',$acnt_mngr_id);										if($this->session->userdata('adm_admin_type') == 'CLIENT')					{						$this->session->set_userdata('adm_admin_currency',$currency);						if(!empty($_SERVER['HTTP_CLIENT_IP'])){							//ip from share internet							$ip = $_SERVER['HTTP_CLIENT_IP'];						}elseif(!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){							//ip pass from proxy							$ip = $_SERVER['HTTP_X_FORWARDED_FOR'];						}else{							$ip = $_SERVER['REMOTE_ADDR'];						}												$data = array(							'fld_clientid'		=>	$admin_id,							'fld_ipaddress'		=>	$ip,							'fld_login_time'	=>	date('Y-m-d H:i:s'),						);						$this->db->insert('tbl_login_history',$data);												$insertid = $this->db->insert_id();						$this->session->set_userdata('adm_admin_loginid',$insertid);					}										$mandrill = new Mandrill(MANDRILL_KEY);					$Subject = "PhD Wallet Account Verified & Activated";					$body = emailerDesign(1);					$body .= 'Hi '.$name.'<br/><br/>						 					Your account is successfully verified now. You can now explore the services and avail any of them using the funds that are added in your PhD Wallet along with many more features to explore.<br/><br/>												We are happy that you are part of our family now<br/><br/><br/>					Thanks &amp; Regards<br/>					Team '.WEBNAME;					$body .= emailerDesign(2);					$message = array(					'html' => $body,					'subject' => $Subject,					'from_email' => FROM_EMAIL,					'from_name' => FROM_NAME,					'to' => array(					array(					'email' => $email,					'name' => $name,					'type' => 'to'					)					)					);					$async = false;					$ip_pool = '';					$result = $mandrill->messages->send($message, $async, $ip_pool);										if($this->session->userdata('RCHRG_AMOUNT')>0)					{						echo 'success_template';						exit;					}					else					{						echo 'success';						exit;					}				}				else				{					echo 'fail';					exit;				}			}			else			{				echo 'error';				exit;			}		}	}		public function referral()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{				$data['module'] = 'referral';						$data['referrer_code'] = $referrer_code = $this->uri->segment(3);			$data['userid'] = $userid = $this->uri->segment(4);			$data['referrer_id'] = $referrer_id = $this->uri->segment(2);						if($referrer_id!="")			{				$data['result'] 		= getAdmin($userid,'CLIENT');				$data['main_content'] 	= 'referral';				$this->load->view('referral',$data);			}			else			{				redirect(base_url());			}		}	}			public function registration()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{				$data['module'] = 'registration';			$data['template_id'] = $template_id = $this->uri->segment(2);						$data['result'] 		= getAdmin($userid,'CLIENT');			$data['main_content'] 	= 'referral';			$this->load->view('referral',$data);		}	}		public function submitreferral()	{		if($this->session->userdata('adm_logged_in') == true)		{			redirect(base_url().'dashboard/');			exit;		}		else		{							//exit;			$referrer_id 	= $this->input->post('referrer_id');			$referrer_code 	= $this->input->post('referrer_code');			$userid 		= $this->input->post('userid');			$template_id 	= $this->input->post('template_id');			$module 		= $this->input->post('module');						$state				= trim($this->input->post('state'));			$city				= trim($this->input->post('city'));			$country		    = trim($this->input->post('country'));			$address1			= trim($this->input->post('address1'));			$address2			= trim($this->input->post('address2'));			$landmark			= trim($this->input->post('landmark'));			$pincode			= trim($this->input->post('pincode'));			$amount				= trim($this->input->post('amount'));						$name 			= $this->input->post('name');			$email 			= $this->input->post('email');			$phone			= $this->input->post('phone');			$password 		= chr(rand(65,90)).rand(111,999).chr(rand(65,90)).chr(rand(65,90)).rand(111,999);			$currency 		= $this->input->post('currency');									$clientid 		= getClientid();			$verify 		= rand(111111,999999);						$refcode = base64_decode(trim($referrer_code));						$accountmngr = '';			if($referrer_id>0)			{				$referreinfo = getAdmin($referrer_id);								$accountmngr = $referreinfo->fld_acnt_mngr_id;			}						if($accountmngr=="")			{				$accountmngr = $this->input->post('accountmngr');			}			$client_code = $referreinfo->fld_client_code;			if($client_code == $refcode || $template_id>0 || $module == 'registration')			{				//echo 'matched';								$this->db->select('*');				$this->db->from('tbl_admin');				$this->db->where('fld_email',$email);				$this->db->where('status','Inactive');				$query = $this->db->get();				//echo $this->db->last_query();				//echo $query->num_rows();				if($query->num_rows()==0 && $email!="")				{					if($amount>0)					{						$this->session->set_userdata('RCHRG_AMOUNT', $amount);					}										$regi_type = 'Social';					if($module == 'registration')					{						$regi_type = 'Panel';					}										$data = array(						'fld_acnt_mngr_id'		=>	$accountmngr,						'fld_referrerid'		=>	$referrer_id,						'fld_templateid'		=>	$template_id,						'fld_admin_type'		=>	'CLIENT',						'fld_client_regi_type'	=>	$regi_type,						'fld_client_ac_type'	=>	'PAID',						'fld_client_code'		=>	$clientid,						'fld_verify'			=>	$verify,						'fld_phone'				=>	$phone,						'fld_password'			=>	md5($password),						'fld_decrypt_password'	=>	$password,						'fld_name'				=>	$name,						'fld_email'				=>	trim($email),						'fld_currency'			=>	$currency,						'status'				=>	'Inactive',						'fld_state'				=> $state,						'fld_city'				=> $city,						'fld_country'			=> $country,						'fld_address'			=> $address1,						'fld_address_line2'		=> $address2,						'fld_pincode'			=> $pincode,						'fld_landmark'			=> $landmark,						'fld_addedon'			=>	date('Y-m-d')					);					$this->db->insert('tbl_admin',$data);					$insertid = $this->db->insert_id();										$this->session->set_userdata('alert_type', 'success');					$this->session->set_userdata('msg', 'Congratulation your account is created successfully. Please check your inbox we have sent an email');				}				else				{					$result = $query->row();										if($result->status == 'Inactive')					{						if($amount>0)						{							$this->session->set_userdata('RCHRG_AMOUNT', $amount);						}											$data = array(							'fld_templateid'		=>	$template_id,							'fld_referrerid'		=>	$referrer_id,							'fld_verify'			=>	$verify,							'fld_phone'				=>	$phone,							'fld_name'				=>	$name,							'fld_email'				=>	trim($email),							'fld_currency'			=>	$currency,							'fld_state'				=> $state,							'fld_city'				=> $city,							'fld_country'			=> $country,							'fld_address'			=> $address1,							'fld_address_line2'		=> $address2,							'fld_pincode'			=> $pincode,							'fld_landmark'			=> $landmark,							'fld_addedon'			=> date('Y-m-d')						);						$this->db->where('id',$result->id);						$this->db->update('tbl_admin',$data);						$password = $result->fld_decrypt_password;						$insertid = $result->id;												$this->session->set_userdata('alert_type', 'success');						$this->session->set_userdata('msg', 'Congratulation your account is created successfully. Please check your inbox we have sent an email');					}					else					{						$this->session->set_userdata('alert_type', 'danger');						$this->session->set_userdata('msg', 'Your are already registered with us and your account already activated');					}				}								if($insertid>0)				{					if($module == 'registration')					{						$ref_no = "PYMNT#".rand(111,999)."PHD".rand(11111,99999);						$data_payment = array(							'fld_ref_no'			=>	$ref_no,							'fld_admin_id'			=>	$accountmngr,							'fld_client_id'			=>	$insertid,							'fld_amount'			=>	$amount,							'fld_transaction_type'	=>	'REWARD',							'fld_expiry_date'		=>	date('Y-m-d H:i:s', strtotime('+3 days')),							'fld_addedon'			=>	date('Y-m-d H:i:s'),							'status'				=>	'Paid'						);						$this->db->insert('tbl_payment_history',$data_payment);					}										$mandrill = new Mandrill(MANDRILL_KEY);									$body = emailerDesign(1);					$body .= 'Dear '.$name.'<br/><br/>										We Welcome you to '.WEBNAME.'<br/><br/>										Your account has been created successfully below are the credentials for your account on '.WEBNAME.'<br/><br/>															Please verify your account by clicking on below verify button.<br/><br/>										Login Id: '.$email.'<br/>					Password: '.$password.'<br/><br/>										<a href="'.base_url().'login/verify/'.$verify.'/'.$insertid.'" style="    text-align: center;					background-color: #21219a;					margin: 0 auto;					color: #FFF;					padding: 15px 65px 15px 65px;					text-decoration: none;					width: 220px;">Verify your account</a><br/><br/>										Thanks &amp; Regards<br/>					Team '.WEBNAME;					$body .= emailerDesign(2);					//echo $body;					//exit;										$Subject = "Wallet Account Created || ".WEBNAME;					$message = array(						'html' => $body,						'subject' => $Subject,						'from_email' => FROM_EMAIL,						'from_name' => FROM_NAME,						'to' => array(							array(							'email' => $email,							'name' => $name,							'type' => 'to'							)						)					);					$async = false;					$ip_pool = '';					if($_SERVER['HTTP_HOST']!="localhost")					{						$result = $mandrill->messages->send($message, $async, $ip_pool);					}									}								if($referrer_id>0)				{					redirect(base_url().'referral/'.$referrer_id.'/'.$referrer_code.'/');				}				else				{					redirect(base_url().'registration/'.$template_id);				}			}			else			{				$this->session->set_userdata('alert_type', 'danger');				$this->session->set_userdata('msg', 'Invalid referrer url');				redirect(base_url().'referral/'.$referrer_id.'/'.$referrer_code.'/');			}					}	}}